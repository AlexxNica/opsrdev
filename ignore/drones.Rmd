---
title: "OPS Drones Example"
author: "Paul Oldham"
date: "29 July 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# opsrdev
[![Travis-CI Build Status](https://travis-ci.org/poldham/opsrdev.svg?branch=master)](https://travis-ci.org/poldham/opsrdev)

This is the early development version of the opsr R package to access the [EPO Open Patent Services API](http://www.epo.org/searching-for-patents/technical/espacenet/ops.html#tab1)

The main aim of the package is to provide access to the OPS service and, more importantly, to transform the data into data frames (tibbles) that we can perform useful patent analysis with. There is still a way to go and if you would like to contribute feel welcome. 

opsrdev is not on CRAN. To install it use: 

```{r}
devtools::install_github("poldham/opsrdev")
```

Here is a quick walkthrough on how to use it using the topic of drones as an example. 

opsr uses r packages in the tidyverse as well as some additional packages. 

Load dplyr to use %>% in interactive mode and opsrdev. Use the small green arrow to the right to run the code. 

```{r}
library(dplyr) # for chaining as "do this then that" using %>% 
library(opsrdev) # the opsr package
library(readr) # to write the file
```

OPS will allow us to make limited use of the service without authenticating, but they plan to turn that off. It is a good idea to register for the service [here](), then create an App in the developer portal and copy down the key and secret. You may find it easiest to save the key and the secret in your environment using: 

```{r}
key <- "yourkey"
secret <- "yoursecret"
```

`ops_auth()` is a simple function

Authenticate (not needed for this walkthrough as the dataset is small but good practice)
```{r}
ops_auth("yourkeyhere", "yoursecret")
```

## Test a query for the number of results with ops_count()

We can only fetch 2000 results at a time from the OPS service. So, we need to find out whether we have 2000 or more results.

### Get a Count for Patent Biblios (front pages)

Patent biblios include the title, abstract, applicant and inventor fields. 

```{r}
ops_count("drones") # biblio search is the default for ops_count() and "biblio" does not need to be specified.
```

### Get a Count for Titles

```{r cars}
ops_count("drones", "ti") # titles, all years
```

### Get a Count for the Titles and Abstract

```{r}
ops_count("drones", "ta") # title and abstract, all years
```

Use a shorter year range if you have too many results (over 2000). Note that the year is the publication year. 

```{r}
ops_count("drones", "ta", start = 1990, end = 2015) # 1990 to 2015
```

## Retrieve the data from OPS

Note that this code demonstrates that the three functions to generate urls, fetch the data and process it into a data.frame can be combined. In future the three functions will be combined into one easy to use and understand function (could maybe call it ops_search?). This could maybe become a GUI with search, search field, search years, search service (numbers, biblio, full text) and timer (for larger queries).

```{r warning=FALSE}
library(dplyr)
drones <- ops_urls(query = "drones", type = "ta", start = 1990, end = 2015) %>% ops_iterate(., service = "biblio", timer = 10) %>% # fetches the data
  ops_biblio() # turns the JSON data into a data.frame
```

View the data frame with the results

```{r}
View(drones)
```

Write the data to a file

```{r}
write_csv(drones, "drones.csv")
```

#Mine into the titles

We can mine into the titles by first selecting the fields we need. 

```{r}
library(dplyr)
tab <- select(drones, publication_number, title, abstract)
```

We want to join the title and the abstracts together and then break them up into phrases. We can use the new tokenizers package to do this quite easily.

```{r}
install.packages("tokenizers")
library(tokenizers)
```

```{r}
tab <- tidyr::unite(tab, "title_and_abstract", c(title, abstract), sep = " ")
```

Next we need to break up the title field into chunks

```{r}
test <- tokenize_ngrams(tab$title_and_abstract, lowercase = TRUE, n = 2L, stopwords())
names(tab) <- tab$publication_number
tab
```

