---
title: "Untitled"
author: "Paul Oldham"
date: "18 August 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Drones data from the European Patent Office Open Patent Services (OPS) with opsr

A quick example of how to retrieve data on drones from the EPO Open Patent Services. 

Load dplyr to use %>% in interactive mode and opsrdev. Use the small green arrow to the right to run the code. 

```{r}
library(dplyr) # for chaining as "do this then that" using %>% 
library(opsrdev) # the opsr package
library(readr) # to write the file
```

Authenticate (not needed for this example as the dataset is small but good practice)
```{r}
ops_auth("yourkeyhere", "yoursecrethere")
```

## Test a query for the number of results with ops_count()

We need to find out whether we have 2000 or more results (as 2000 is the maximum data we can get from a single search).

### Get a Count for Patent Biblios (front pages)

Patent biblios include the title, abstract, applicant and inventor fields. 

```{r}
ops_count("drones") # biblio search is the default for ops_count() and "biblio" does not need to be specified.
```

### Get a Count for Titles

```{r cars}
ops_count("drones", "ti") # titles, all years
```

### Get a Count for the Titles and Abstract

```{r}
ops_count("drones", "ta") # title and abstract, all years
```

Use a shorter year range if you have too many results (over 2000). Note that the year is the publication year. 

```{r}
ops_count("drones", "ta", start = 1990, end = 2015) # 1990 to 2015
```

## Retrieve the data from OPS

Note that this code demonstrates that the three functions to generate urls, fetch the data and process it into a data.frame can be combined. In future the three functions will be combined into one easy to use and understand function (could maybe call it ops_search?). This could maybe become a GUI with search, search field, search years, search service (numbers, biblio, full text) and timer (for larger queries).

```{r warning=FALSE}
drones <- ops_urls(query = "drones", type = "ta", start = 1990, end = 2015) %>% ops_iterate(., service = "biblio", timer = 10) %>% # fetches the data
  ops_biblio() # turns the JSON data into a data.frame
```

The above is the working basis for ops_fetch. May need to be ops_fetch_biblio initially as it will only work with biblios. 

```{r}
library(dplyr)
ops_fetch_biblio <- function(query, type, service, start, end, timer){
  ops_urls(query, type, start, end) %>% 
  ops_iterate(service, timer) %>% 
    ops_biblio() # generates a warning here
}
```

```{r}
drones_test <- ops_fetch_biblio("drones", type = "ta", service = "biblio", start = 1990, end = 2015, timer = 10)
# returns the data but with lots of no non-missing
```


View the data frame with the results

```{r}
View(drones)
```

Write the data to a file

```{r}
write_csv(drones, "drones.csv")
```